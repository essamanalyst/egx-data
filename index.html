<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EGX â€” Ø§Ù„Ø¨ÙˆØ±ØµØ© Ø§Ù„Ù…ØµØ±ÙŠØ© | Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</title>
<meta name="description" content="Ù…Ù†ØµØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ø¨ÙˆØ±ØµØ© Ø§Ù„Ù…ØµØ±ÙŠØ©">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” Refined Dark Financial Terminal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ink:       #060C14;
  --deep:      #0A1628;
  --panel:     #0F2040;
  --panel2:    #152A50;
  --rim:       #1E3F6E;
  --gold:      #C8A84B;
  --gold-lt:   #E8CC7A;
  --gold-glow: rgba(200,168,75,.35);
  --sky:       #38BDF8;
  --emerald:   #10B981;
  --rose:      #F43F5E;
  --chalk:     #CBD5E1;
  --fog:       #64748B;
  --r:         16px;
}

*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }

html { scroll-behavior:smooth; }

body {
  font-family:'Cairo', sans-serif;
  background: var(--ink);
  color: var(--chalk);
  min-height:100vh;
  position:relative;
  overflow-x:hidden;
}

/* Animated background */
body::before {
  content:'';
  position:fixed; inset:0; z-index:0;
  background:
    radial-gradient(ellipse 90% 70% at -10% 0%, rgba(21,101,192,.18) 0%, transparent 55%),
    radial-gradient(ellipse 60% 50% at 110% 100%, rgba(200,168,75,.09) 0%, transparent 55%),
    radial-gradient(ellipse 40% 40% at 50% 50%, rgba(56,189,248,.04) 0%, transparent 60%);
}

/* Grid lines */
.grid-bg {
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background-image:
    linear-gradient(rgba(30,63,110,.25) 1px, transparent 1px),
    linear-gradient(90deg, rgba(30,63,110,.25) 1px, transparent 1px);
  background-size:64px 64px;
  mask-image:radial-gradient(ellipse 120% 100% at 50% 0%, black 30%, transparent 80%);
}

/* â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position:sticky; top:0; z-index:100;
  height:66px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 32px;
  background:rgba(6,12,20,.85);
  backdrop-filter:blur(24px);
  border-bottom:1px solid var(--rim);
}

.brand {
  display:flex; align-items:center; gap:14px;
}

.brand-mark {
  width:40px; height:40px; border-radius:10px;
  background:linear-gradient(135deg, var(--gold), #A07820);
  display:flex; align-items:center; justify-content:center;
  font-size:20px; font-weight:900; color:var(--ink);
  box-shadow:0 0 18px var(--gold-glow);
  flex-shrink:0;
}

.brand-copy h1 { font-size:15px; font-weight:800; color:#F1F5F9; }
.brand-copy small { font-size:10px; color:var(--fog); letter-spacing:.5px; }

.header-right {
  display:flex; align-items:center; gap:12px;
}

.pill {
  display:flex; align-items:center; gap:6px;
  padding:5px 14px; border-radius:100px;
  font-size:11px; font-weight:600;
  border:1px solid;
}
.pill-green {
  background:rgba(16,185,129,.1);
  border-color:rgba(16,185,129,.35);
  color:var(--emerald);
}
.pill-gold {
  background:rgba(200,168,75,.1);
  border-color:rgba(200,168,75,.35);
  color:var(--gold-lt);
}

.dot {
  width:6px; height:6px; border-radius:50%;
  background:currentColor;
  animation:blink 2s ease infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

/* â•â•â• HERO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero {
  position:relative; z-index:1;
  text-align:center;
  padding:56px 24px 40px;
}

.hero-eyebrow {
  display:inline-flex; align-items:center; gap:8px;
  padding:5px 16px; border-radius:100px;
  background:rgba(200,168,75,.08);
  border:1px solid rgba(200,168,75,.25);
  font-size:11px; font-weight:600; letter-spacing:1.5px;
  color:var(--gold-lt); text-transform:uppercase;
  margin-bottom:20px;
}

.hero h2 {
  font-size:clamp(30px,5vw,52px);
  font-weight:900; line-height:1.15;
  margin-bottom:16px;
  background:linear-gradient(135deg, var(--gold-lt) 0%, #F8FAFC 40%, var(--sky) 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
}

.hero p {
  font-size:15px; color:var(--fog);
  max-width:520px; margin:0 auto; line-height:1.8;
}

/* â•â•â• KPI ROW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpi-row {
  position:relative; z-index:1;
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:14px;
  padding:0 32px 32px;
  max-width:1320px; margin:0 auto;
}

.kpi {
  background:var(--panel);
  border:1px solid var(--rim);
  border-radius:var(--r);
  padding:18px 22px;
  text-align:center;
  position:relative; overflow:hidden;
  transition:.25s;
}
.kpi::after {
  content:''; position:absolute;
  top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity:.6;
}
.kpi:hover { border-color:var(--gold); transform:translateY(-2px); }
.kpi-val { font-size:30px; font-weight:900; color:var(--gold-lt); }
.kpi-lbl { font-size:12px; color:var(--fog); margin-top:4px; }

/* â•â•â• MAIN LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.layout {
  position:relative; z-index:1;
  display:grid;
  grid-template-columns:320px 1fr;
  gap:20px;
  max-width:1320px; margin:0 auto;
  padding:0 32px 60px;
}

/* â•â•â• PANEL BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background:var(--panel);
  border:1px solid var(--rim);
  border-radius:var(--r);
  overflow:hidden;
}

.card-head {
  padding:15px 20px;
  border-bottom:1px solid var(--rim);
  display:flex; align-items:center; justify-content:space-between;
}

.card-title {
  display:flex; align-items:center; gap:8px;
  font-size:13px; font-weight:700; color:#E2E8F0;
}

.icon-badge {
  width:28px; height:28px; border-radius:7px;
  background:rgba(200,168,75,.12);
  display:flex; align-items:center; justify-content:center;
  font-size:14px;
}

.card-body { padding:16px 18px; }

/* â•â•â• STOCK SELECTOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.search-wrap { position:relative; margin-bottom:12px; }

.search-wrap input {
  width:100%;
  background:var(--deep);
  border:1px solid var(--rim);
  border-radius:10px;
  padding:9px 38px 9px 14px;
  font-family:'Cairo',sans-serif; font-size:13px;
  color:var(--chalk); outline:none;
  transition:.25s;
}
.search-wrap input::placeholder { color:var(--fog); }
.search-wrap input:focus { border-color:var(--gold); box-shadow:0 0 0 3px var(--gold-glow); }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:14px; pointer-events:none; }

/* Sector chips */
.chips {
  display:flex; flex-wrap:wrap; gap:5px;
  margin-bottom:12px;
}
.chip {
  padding:3px 10px; border-radius:100px;
  font-size:10px; font-weight:600; cursor:pointer;
  border:1px solid var(--rim); color:var(--fog);
  background:var(--deep); transition:.2s;
  white-space:nowrap;
}
.chip:hover { border-color:var(--gold); color:var(--gold-lt); }
.chip.on { background:rgba(200,168,75,.12); border-color:var(--gold); color:var(--gold-lt); }

/* Actions row */
.row-btns {
  display:flex; gap:8px; margin-bottom:12px;
}
.btn-xs {
  flex:1; padding:6px; border-radius:8px; font-size:11px;
  font-family:'Cairo',sans-serif; font-weight:600;
  cursor:pointer; border:1px solid; transition:.2s;
}
.btn-xs.primary { background:rgba(200,168,75,.12); border-color:var(--gold); color:var(--gold-lt); }
.btn-xs.ghost   { background:transparent; border-color:var(--rim); color:var(--fog); }
.btn-xs:hover.primary { background:rgba(200,168,75,.22); }
.btn-xs:hover.ghost   { border-color:var(--gold); color:var(--gold-lt); }

/* Stock list */
.stock-list {
  max-height:350px; overflow-y:auto;
  padding-left:3px;
}
.stock-list::-webkit-scrollbar { width:3px; }
.stock-list::-webkit-scrollbar-thumb { background:var(--rim); border-radius:3px; }

.sitem {
  display:flex; align-items:center; gap:9px;
  padding:8px 10px; border-radius:9px;
  cursor:pointer; transition:.18s;
  border:1px solid transparent;
  margin-bottom:3px;
}
.sitem:hover { background:var(--panel2); }
.sitem.on { background:rgba(200,168,75,.08); border-color:rgba(200,168,75,.3); }

.scheck {
  width:17px; height:17px; border-radius:4px; flex-shrink:0;
  border:2px solid var(--rim); transition:.18s;
  display:flex; align-items:center; justify-content:center;
  font-size:10px;
}
.sitem.on .scheck { background:var(--gold); border-color:var(--gold); color:var(--ink); font-weight:900; }

.sinfo { flex:1; min-width:0; }
.sticker { font-size:11px; font-weight:800; color:var(--gold-lt); }
.sname { font-size:10px; color:var(--fog); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.stag {
  font-size:9px; padding:2px 7px; border-radius:100px; flex-shrink:0;
  background:rgba(56,189,248,.08); color:var(--sky);
  border:1px solid rgba(56,189,248,.2);
}

/* â•â•â• RIGHT COLUMN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.right-col { display:flex; flex-direction:column; gap:18px; }

/* Chart card */
.chart-meta {
  display:flex; gap:14px; margin-bottom:14px;
}
.meta-box {
  flex:1; background:var(--deep);
  border:1px solid var(--rim); border-radius:10px;
  padding:10px 14px; text-align:center;
}
.meta-val { font-size:17px; font-weight:800; }
.meta-lbl { font-size:10px; color:var(--fog); }

.chart-area { height:220px; position:relative; }

.chart-controls {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:12px;
}

.chart-select {
  background:var(--deep); border:1px solid var(--rim);
  border-radius:8px; padding:5px 12px;
  font-family:'Cairo',sans-serif; font-size:11px;
  color:var(--gold-lt); outline:none; cursor:pointer;
}

.timeframe-btns { display:flex; gap:4px; }
.tf-btn {
  padding:4px 10px; border-radius:6px;
  font-size:10px; font-weight:700; cursor:pointer;
  border:1px solid var(--rim); background:transparent;
  color:var(--fog); font-family:'Cairo',sans-serif;
  transition:.15s;
}
.tf-btn:hover { border-color:var(--gold); color:var(--gold-lt); }
.tf-btn.on { background:rgba(200,168,75,.12); border-color:var(--gold); color:var(--gold-lt); }

/* Settings card */
.field { margin-bottom:14px; }
.field label { display:block; font-size:11px; color:var(--fog); font-weight:600; margin-bottom:5px; }
.field input, .field select {
  width:100%;
  background:var(--deep); border:1px solid var(--rim);
  border-radius:9px; padding:9px 13px;
  font-family:'Cairo',sans-serif; font-size:12px;
  color:var(--chalk); outline:none; transition:.25s;
}
.field input:focus, .field select:focus { border-color:var(--gold); }
.field select option { background:var(--panel); }

.fields-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* Quick range */
.qrange { display:flex; gap:6px; margin-bottom:14px; }
.qbtn {
  flex:1; padding:6px; border-radius:7px; cursor:pointer;
  font-size:11px; font-weight:700; font-family:'Cairo',sans-serif;
  border:1px solid var(--rim); background:var(--deep); color:var(--fog);
  transition:.18s;
}
.qbtn:hover { border-color:var(--gold); color:var(--gold-lt); }
.qbtn.on { background:rgba(200,168,75,.12); border-color:var(--gold); color:var(--gold-lt); }

/* Format */
.fmt-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px; }
.fmt-btn {
  padding:10px; border-radius:9px; cursor:pointer;
  font-family:'Cairo',sans-serif; font-size:12px; font-weight:600;
  border:2px solid; transition:.2s;
  display:flex; align-items:center; justify-content:center; gap:6px;
}
.fmt-btn.xl { background:rgba(56,189,248,.06); border-color:rgba(56,189,248,.35); color:var(--sky); }
.fmt-btn.cs { background:rgba(16,185,129,.06); border-color:rgba(16,185,129,.35); color:var(--emerald); }
.fmt-btn.on.xl { background:rgba(56,189,248,.14); }
.fmt-btn.on.cs { background:rgba(16,185,129,.14); }
.fmt-btn.on { transform:scale(1.02); }

/* Counter badge */
.counter-strip {
  display:flex; align-items:center; justify-content:space-between;
  background:var(--deep); border:1px solid var(--rim);
  border-radius:10px; padding:10px 16px; margin-bottom:12px;
  font-size:12px;
}
.counter-num { font-size:24px; font-weight:900; color:var(--gold-lt); }

/* Progress */
.progress-area { display:none; margin-bottom:12px; }
.progress-area.show { display:block; }
.prog-track {
  height:6px; background:var(--deep);
  border-radius:100px; overflow:hidden; margin:8px 0;
}
.prog-fill {
  height:100%; width:0%;
  background:linear-gradient(90deg, var(--gold), var(--sky));
  border-radius:100px; transition:width .35s ease;
  box-shadow:0 0 8px rgba(56,189,248,.5);
}
.prog-lbl { font-size:11px; color:var(--fog); text-align:center; }

/* CTA button */
.cta {
  width:100%; padding:15px; border-radius:11px;
  background:linear-gradient(135deg, var(--gold) 0%, #8A6010 100%);
  border:none; cursor:pointer;
  font-family:'Cairo',sans-serif; font-size:15px; font-weight:800;
  color:var(--ink);
  display:flex; align-items:center; justify-content:center; gap:10px;
  transition:.3s;
  box-shadow:0 4px 24px rgba(200,168,75,.3);
  position:relative; overflow:hidden;
}
.cta::before {
  content:''; position:absolute; inset:0;
  background:linear-gradient(135deg, rgba(255,255,255,.15), transparent);
  opacity:0; transition:.3s;
}
.cta:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 8px 32px rgba(200,168,75,.5); }
.cta:hover:not(:disabled)::before { opacity:1; }
.cta:disabled { opacity:.45; cursor:not-allowed; transform:none; }

.spinner {
  width:16px; height:16px; border-radius:50%;
  border:2px solid rgba(6,12,20,.3); border-top-color:var(--ink);
  animation:spin .7s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast {
  position:fixed; bottom:28px; left:50%; z-index:999;
  transform:translateX(-50%) translateY(60px);
  background:var(--panel2); border:1px solid var(--rim);
  border-radius:12px; padding:13px 22px;
  font-size:13px; font-weight:600;
  box-shadow:0 12px 40px rgba(0,0,0,.6);
  display:flex; align-items:center; gap:10px;
  transition:transform .4s cubic-bezier(.175,.885,.32,1.275);
  white-space:nowrap;
}
#toast.show { transform:translateX(-50%) translateY(0); }
#toast.ok { border-color:var(--emerald); }
#toast.err { border-color:var(--rose); }

/* â•â•â• NOTICE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.notice {
  position:relative; z-index:1;
  max-width:1320px; margin:0 auto 18px;
  padding:0 32px;
}
.notice-box {
  background:rgba(56,189,248,.06);
  border:1px solid rgba(56,189,248,.25);
  border-radius:10px; padding:11px 18px;
  font-size:12px; color:#94D9F5;
  display:flex; align-items:flex-start; gap:8px; line-height:1.6;
}

/* â•â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
footer {
  position:relative; z-index:1;
  border-top:1px solid var(--rim);
  padding:20px 32px;
  display:flex; align-items:center; justify-content:space-between;
  font-size:11px; color:var(--fog);
}

/* â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:900px){
  .layout { grid-template-columns:1fr; }
  .kpi-row { grid-template-columns:1fr 1fr; }
  header { padding:0 16px; }
  .hero h2 { font-size:26px; }
  .layout, .kpi-row, .notice { padding-right:16px; padding-left:16px; }
}
</style>
</head>
<body>
<div class="grid-bg"></div>

<!-- HEADER -->
<header>
  <div class="brand">
    <div class="brand-mark">Ù…</div>
    <div class="brand-copy">
      <h1>Ø§Ù„Ø¨ÙˆØ±ØµØ© Ø§Ù„Ù…ØµØ±ÙŠØ© â€” EGX</h1>
      <small>HISTORICAL DATA PLATFORM Â· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</small>
    </div>
  </div>
  <div class="header-right">
    <div class="pill pill-gold"><span class="dot"></span>Yahoo Finance API</div>
    <div class="pill pill-green"><span class="dot"></span>Ù…Ø¬Ø§Ù†ÙŠ 100%</div>
  </div>
</header>

<!-- HERO -->
<div class="hero">
  <div class="hero-eyebrow">
    <span>âš¡</span> POWERED BY YAHOO FINANCE
  </div>
  <h2>Ù…Ù†ØµØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</h2>
  <p>ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ø¢Ø®Ø± 10 Ø³Ù†ÙˆØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ â€” Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±ØŒ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„</p>
</div>

<!-- KPIs -->
<div class="kpi-row">
  <div class="kpi">
    <div class="kpi-val" id="k-total">35+</div>
    <div class="kpi-lbl">Ø´Ø±ÙƒØ© Ù…ØªØ§Ø­Ø©</div>
  </div>
  <div class="kpi">
    <div class="kpi-val" id="k-sel">0</div>
    <div class="kpi-lbl">Ù…Ø®ØªØ§Ø±Ø©</div>
  </div>
  <div class="kpi">
    <div class="kpi-val">10</div>
    <div class="kpi-lbl">Ø³Ù†ÙˆØ§Øª Ø¨ÙŠØ§Ù†Ø§Øª</div>
  </div>
  <div class="kpi">
    <div class="kpi-val">8+</div>
    <div class="kpi-lbl">Ù‚Ø·Ø§Ø¹Ø§Øª</div>
  </div>
</div>

<!-- NOTICE -->
<div class="notice">
  <div class="notice-box">
    <span>â„¹ï¸</span>
    <div>
      Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ¬Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù…Ù† <strong>Yahoo Finance</strong> Ø¹Ø¨Ø± Ø§Ù„Ù…ØªØµÙØ­. Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆÙ‚ØªØ§Ù‹ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯Ù‡Ø§ ÙˆØ³Ø±Ø¹Ø© Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠØªÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.
    </div>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="layout">

  <!-- LEFT: Stock Selector -->
  <div class="card" style="align-self:start; position:sticky; top:80px;">
    <div class="card-head">
      <div class="card-title">
        <div class="icon-badge">ğŸ“‹</div>
        Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø¯Ø±Ø¬Ø©
      </div>
      <span id="vis-count" style="font-size:11px;color:var(--fog)"></span>
    </div>
    <div class="card-body">

      <div class="search-wrap">
        <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²..." oninput="renderList()">
        <span class="search-icon">ğŸ”</span>
      </div>

      <div class="chips" id="chips"></div>

      <div class="row-btns">
        <button class="btn-xs primary" onclick="selectAll()">âœ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
        <button class="btn-xs ghost"   onclick="clearAll()">âœ• Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
      </div>

      <div class="stock-list" id="stock-list"></div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-col">

    <!-- CHART CARD -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <div class="icon-badge">ğŸ“ˆ</div>
          Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ù‡Ù…
        </div>
        <select class="chart-select" id="chart-ticker" onchange="previewTicker()"></select>
      </div>
      <div class="card-body">
        <div class="chart-controls">
          <div class="timeframe-btns">
            <button class="tf-btn" onclick="setTF(7)"    data-d="7">Ø£Ø³Ø¨ÙˆØ¹</button>
            <button class="tf-btn on" onclick="setTF(30)" data-d="30">Ø´Ù‡Ø±</button>
            <button class="tf-btn" onclick="setTF(90)"   data-d="90">3 Ø£Ø´Ù‡Ø±</button>
            <button class="tf-btn" onclick="setTF(365)"  data-d="365">Ø³Ù†Ø©</button>
          </div>
          <div id="chart-status" style="font-size:11px;color:var(--fog)"></div>
        </div>
        <div class="chart-meta">
          <div class="meta-box">
            <div class="meta-val" id="m-close">â€”</div>
            <div class="meta-lbl">Ø¢Ø®Ø± Ø¥ØºÙ„Ø§Ù‚ (Ø¬Ù†ÙŠÙ‡)</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="m-chg">â€”</div>
            <div class="meta-lbl">Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="m-pct">â€”</div>
            <div class="meta-lbl">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ± %</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="m-vol">â€”</div>
            <div class="meta-lbl">Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„</div>
          </div>
        </div>
        <div class="chart-area">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>

    <!-- SETTINGS + DOWNLOAD CARD -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <div class="icon-badge">âš™ï¸</div>
          Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
        </div>
      </div>
      <div class="card-body">

        <!-- Date range -->
        <div class="fields-2" style="margin-bottom:10px">
          <div class="field" style="margin:0">
            <label>ğŸ“… Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="start-date">
          </div>
          <div class="field" style="margin:0">
            <label>ğŸ“… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="end-date">
          </div>
        </div>

        <!-- Quick range -->
        <div class="qrange" style="margin-bottom:14px">
          <button class="qbtn" onclick="qRange(1,this)">Ø³Ù†Ø©</button>
          <button class="qbtn" onclick="qRange(3,this)">3 Ø³Ù†ÙˆØ§Øª</button>
          <button class="qbtn" onclick="qRange(5,this)">5 Ø³Ù†ÙˆØ§Øª</button>
          <button class="qbtn on" onclick="qRange(10,this)">10 Ø³Ù†ÙˆØ§Øª</button>
        </div>

        <!-- Format -->
        <div style="font-size:12px;font-weight:700;color:#94A3B8;margin-bottom:8px">ØµÙŠØºØ© Ø§Ù„Ù…Ù„Ù</div>
        <div class="fmt-row">
          <button class="fmt-btn xl on" onclick="setFmt('xlsx',this)">ğŸ“Š Excel XLSX</button>
          <button class="fmt-btn cs"    onclick="setFmt('csv',this)">ğŸ“„ CSV</button>
        </div>

        <!-- Counter -->
        <div class="counter-strip">
          <span>Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„</span>
          <div style="display:flex;align-items:baseline;gap:4px">
            <span class="counter-num" id="sel-count">0</span>
            <span style="font-size:12px;color:var(--fog)">Ø´Ø±ÙƒØ©</span>
          </div>
        </div>

        <!-- Progress -->
        <div class="progress-area" id="prog-wrap">
          <div class="prog-track">
            <div class="prog-fill" id="prog-fill"></div>
          </div>
          <div class="prog-lbl" id="prog-lbl">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <!-- CTA -->
        <button class="cta" id="cta" onclick="startDownload()">
          <span id="cta-icon">â¬‡ï¸</span>
          <span id="cta-txt">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </button>

      </div>
    </div>

  </div>
</div>

<!-- FOOTER -->
<footer>
  <span>Â© 2025 â€” EGX Historical Data Platform Â· Ù…Ø¨Ù†ÙŠ Ù„Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub Pages</span>
  <span>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±: Yahoo Finance Â· Ø§Ù„ØªØµØ¯ÙŠØ±: SheetJS</span>
</footer>

<!-- TOAST -->
<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STOCKS = {
  "COMI.CA":  {name:"Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ø§Ù„Ø¯ÙˆÙ„ÙŠ (CIB)",          sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
  "HDBK.CA":  {name:"Ø¨Ù†Ùƒ Ø§Ù„Ø¥Ø³ÙƒØ§Ù† ÙˆØ§Ù„ØªØ¹Ù…ÙŠØ±",                sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
  "EGAL.CA":  {name:"Ø¥ÙŠ ÙØ§ÙŠÙ†Ø§Ù†Ø³",                           sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
  "HRHO.CA":  {name:"Ø¥ÙŠ Ø§Ù Ø¬ÙŠ Ù‡ÙŠØ±Ù…ÙŠØ³",                     sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
  "AIVC.CA":  {name:"Ù…ØµØ± Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ø­ÙŠØ§Ø©",                 sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
  "TMGH.CA":  {name:"Ù…Ø¬Ù…ÙˆØ¹Ø© Ø·Ù„Ø¹Øª Ù…ØµØ·ÙÙ‰",                   sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "EMFD.CA":  {name:"Ø§Ù„ØªØ¹Ù…ÙŠØ± ÙˆØ§Ù„Ø¥Ø³ÙƒØ§Ù†",                     sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "OCDI.CA":  {name:"Ø£ÙˆØ±Ø§Ø³ÙƒÙˆÙ… Ù„Ù„ØªÙ†Ù…ÙŠØ©",                    sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "MASR.CA":  {name:"Ù…ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ø³ÙƒØ§Ù†",                 sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "PHDC.CA":  {name:"ÙÙŠÙ„Ø§ Ø§Ù„Ø£Ù‡Ø±Ø§Ù… Ù„Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠØ©",      sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "MNHD.CA":  {name:"Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ± Ù„Ù„Ø¥Ø³ÙƒØ§Ù†",                   sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "ESRS.CA":  {name:"Ø­Ø¯ÙŠØ¯ Ø¹Ø²",                              sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "SVCE.CA":  {name:"Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ Ù„Ù„ÙƒØ§Ø¨Ù„Ø§Øª",                    sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "SWDY.CA":  {name:"Ø§Ù„Ø³ÙˆÙŠØ¯ÙŠ Ø¥Ù„ÙŠÙƒØªØ±ÙŠÙƒ",                    sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "ORWE.CA":  {name:"Ø£ÙˆØ±Ø§Ø³ÙƒÙˆÙ… Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡",                   sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "SKPC.CA":  {name:"Ø³ÙŠØ¯ÙŠ ÙƒØ±ÙŠØ± Ù„Ù„Ø¨ØªØ±ÙˆÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª",            sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "EGTS.CA":  {name:"Ù…ØµØ± Ù„Ù„ØºØ§Ø²Ø§Øª",                         sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "MOIL.CA":  {name:"Ø³ÙŠÙ†Ø§Ø¡ Ù„Ù„Ù…Ù†ØºÙ†ÙŠØ²",                      sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "KABO.CA":  {name:"Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ù„Ù…Ø·Ø§Ø·",                      sector:"ØµÙ†Ø§Ø¹Ø© ÙˆØªØ¹Ø¯ÙŠÙ†"},
  "ETEL.CA":  {name:"Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª",                   sector:"Ø§ØªØµØ§Ù„Ø§Øª ÙˆØªÙ‚Ù†ÙŠØ©"},
  "FWRY.CA":  {name:"ÙÙˆØ±ÙŠ Ù„Ù„ØµØ±Ø§ÙØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©",            sector:"Ø§ØªØµØ§Ù„Ø§Øª ÙˆØªÙ‚Ù†ÙŠØ©"},
  "CIEB.CA":  {name:"Ø³ÙŠ Ø¢ÙŠ Ù„Ù„ØªØ¹Ù„ÙŠÙ…",                       sector:"Ø§ØªØµØ§Ù„Ø§Øª ÙˆØªÙ‚Ù†ÙŠØ©"},
  "AMOC.CA":  {name:"Ù…ØµØ± Ù„ØªÙƒØ±ÙŠØ± Ø§Ù„Ø¨ØªØ±ÙˆÙ„",                  sector:"Ø·Ø§Ù‚Ø© ÙˆØ¨ØªØ±ÙˆÙ„"},
  "ENPI.CA":  {name:"Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©",              sector:"Ø·Ø§Ù‚Ø© ÙˆØ¨ØªØ±ÙˆÙ„"},
  "SUGR.CA":  {name:"Ø§Ù„Ø³ÙƒØ± ÙˆØ§Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„ÙŠØ©",            sector:"ØºØ°Ø§Ø¡ ÙˆØ´Ø±Ø§Ø¨"},
  "JUFO.CA":  {name:"Ø¯ÙˆÙ…ØªÙŠ Ù„Ù„Ø£Ù„Ø¨Ø§Ù†",                       sector:"ØºØ°Ø§Ø¡ ÙˆØ´Ø±Ø§Ø¨"},
  "MFPC.CA":  {name:"Ù…ØµØ± Ø§Ù„Ø¯ÙˆÙ„ÙŠØ© Ù„Ù„Ø£Ø¯ÙˆÙŠØ©",                 sector:"Ø£Ø¯ÙˆÙŠØ© ÙˆØµØ­Ø©"},
  "EGCH.CA":  {name:"Ù…Ù…ØªÙ„ÙƒØ§Øª Ù…ØµØ±",                         sector:"Ø³ÙŠØ§Ø­Ø© ÙˆØ®Ø¯Ù…Ø§Øª"},
  "HELI.CA":  {name:"Ù…ÙŠÙ†Ø§Ø¡ Ø§Ù„Ø¹Ù„Ù…ÙŠÙ† Ù„Ù„Ø³ÙŠØ§Ø­Ø©",               sector:"Ø³ÙŠØ§Ø­Ø© ÙˆØ®Ø¯Ù…Ø§Øª"},
  "EFIC.CA":  {name:"Ø¥ÙŠÙÙŠÙƒ",                               sector:"Ø³ÙŠØ§Ø­Ø© ÙˆØ®Ø¯Ù…Ø§Øª"},
  "MCQE.CA":  {name:"Ù…ØµØ± Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ„ÙØ²ÙŠÙˆÙ†",               sector:"Ø³ÙŠØ§Ø­Ø© ÙˆØ®Ø¯Ù…Ø§Øª"},
  "ISPH.CA":  {name:"Ø±Ø§Ù…ÙŠ Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©",              sector:"ØºØ°Ø§Ø¡ ÙˆØ´Ø±Ø§Ø¨"},
  "GBMI.CA":  {name:"Ø¨Ù†Ùƒ Ø§Ù„Ø¨Ø±ÙƒØ© Ù…ØµØ±",                      sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
  "MNHD.CA":  {name:"Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ± Ù„Ù„Ø¥Ø³ÙƒØ§Ù†",                   sector:"Ø¹Ù‚Ø§Ø±Ø§Øª"},
  "PIOH.CA":  {name:"Ø¨Ø§ÙŠÙˆÙ†ÙŠØ±Ø² Ø§Ù„Ù‚Ø§Ø¨Ø¶Ø©",                    sector:"Ø¨Ù†ÙˆÙƒ ÙˆÙ…Ø§Ù„ÙŠØ©"},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let selected   = new Set();
let sector     = 'all';
let fmt        = 'xlsx';
let previewDays = 30;
let chartInst  = null;
const PROXY    = 'https://corsproxy.io/?';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  const now  = new Date();
  const ago  = new Date(); ago.setFullYear(now.getFullYear() - 10);
  document.getElementById('end-date').value   = now.toISOString().slice(0,10);
  document.getElementById('start-date').value = ago.toISOString().slice(0,10);

  document.getElementById('k-total').textContent = Object.keys(STOCKS).length + '+';
  buildChips();
  renderList();
  buildChartSelect();
  previewTicker();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildChips() {
  const sects = ['all', ...new Set(Object.values(STOCKS).map(s=>s.sector))];
  const cont  = document.getElementById('chips');
  cont.innerHTML = '';
  sects.forEach(s => {
    const el = document.createElement('div');
    el.className = 'chip' + (s === sector ? ' on' : '');
    el.textContent = s === 'all' ? 'ğŸŒ Ø§Ù„ÙƒÙ„' : s;
    el.onclick = () => { sector = s; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on')); el.classList.add('on'); renderList(); };
    cont.appendChild(el);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STOCK LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderList() {
  const q    = document.getElementById('search').value.trim().toLowerCase();
  const list = document.getElementById('stock-list');
  list.innerHTML = '';
  let count = 0;

  Object.entries(STOCKS).forEach(([tk, info]) => {
    if (sector !== 'all' && info.sector !== sector) return;
    if (q && !tk.toLowerCase().includes(q) && !info.name.includes(q)) return;
    count++;
    const on = selected.has(tk);
    const el = document.createElement('div');
    el.className = 'sitem' + (on ? ' on' : '');
    el.innerHTML = `
      <div class="scheck">${on ? 'âœ“' : ''}</div>
      <div class="sinfo">
        <div class="sticker">${tk}</div>
        <div class="sname">${info.name}</div>
      </div>
      <div class="stag">${info.sector}</div>`;
    el.onclick = () => {
      selected.has(tk) ? selected.delete(tk) : selected.add(tk);
      renderList(); updateCounters(); buildChartSelect();
    };
    list.appendChild(el);
  });

  document.getElementById('vis-count').textContent = count + ' Ø´Ø±ÙƒØ©';
  updateCounters();
}

function selectAll() { Object.keys(STOCKS).forEach(t => selected.add(t)); renderList(); buildChartSelect(); }
function clearAll()  { selected.clear(); renderList(); buildChartSelect(); }

function updateCounters() {
  const n = selected.size;
  document.getElementById('k-sel').textContent     = n;
  document.getElementById('sel-count').textContent = n;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART PREVIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildChartSelect() {
  const sel  = document.getElementById('chart-ticker');
  const prev = sel.value;
  sel.innerHTML = '';
  const pool = selected.size > 0 ? [...selected] : Object.keys(STOCKS);
  pool.slice(0,25).forEach(tk => {
    const o = document.createElement('option');
    o.value = tk; o.textContent = `${tk} Â· ${STOCKS[tk]?.name?.slice(0,18)||''}`;
    sel.appendChild(o);
  });
  if (prev && pool.includes(prev)) sel.value = prev;
  else if (pool.length) sel.value = pool[0];
}

function setTF(days) {
  previewDays = days;
  document.querySelectorAll('.tf-btn').forEach(b => {
    b.classList.toggle('on', +b.dataset.d === days);
  });
  previewTicker();
}

async function previewTicker() {
  const tk  = document.getElementById('chart-ticker').value;
  if (!tk) return;
  const stat = document.getElementById('chart-status');
  stat.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...';

  const end  = Math.floor(Date.now() / 1000);
  const start = end - previewDays * 86400;
  const url  = `https://query1.finance.yahoo.com/v8/finance/chart/${tk}?interval=1d&period1=${start}&period2=${end}`;

  try {
    const res  = await fetch(PROXY + encodeURIComponent(url));
    const json = await res.json();
    const r    = json.chart?.result?.[0];
    if (!r) { stat.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'; return; }

    const ts   = r.timestamps || r.timestamp || [];
    const q    = r.indicators.quote[0];
    const dates  = ts.map(t => new Date(t*1000).toLocaleDateString('ar-EG',{month:'short',day:'numeric'}));
    const closes = q.close.map(v => v ? +v.toFixed(2) : null);

    const last   = closes.filter(Boolean).at(-1) || 0;
    const prev   = closes.filter(Boolean).at(-2) || last;
    const chg    = +(last - prev).toFixed(2);
    const pct    = prev ? +((chg/prev)*100).toFixed(2) : 0;
    const vols   = q.volume || [];
    const lastVol = vols.at(-1) || 0;

    const setM = (id,v,color) => { const el = document.getElementById(id); el.textContent = v; if(color) el.style.color = color; };
    setM('m-close', last.toFixed(2));
    setM('m-chg', (chg>=0?'+':'')+chg, chg>=0?'var(--emerald)':'var(--rose)');
    setM('m-pct', (pct>=0?'+':'')+pct+'%', pct>=0?'var(--emerald)':'var(--rose)');
    setM('m-vol', lastVol > 1e6 ? (lastVol/1e6).toFixed(1)+'M' : lastVol > 1e3 ? (lastVol/1e3).toFixed(0)+'K' : lastVol);

    const up = chg >= 0;
    if (chartInst) chartInst.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    chartInst = new Chart(ctx, {
      type:'line',
      data:{
        labels: dates,
        datasets:[{
          label:'Ø§Ù„Ø¥ØºÙ„Ø§Ù‚',
          data: closes,
          borderColor: up ? 'rgba(16,185,129,1)' : 'rgba(244,63,94,1)',
          backgroundColor: up ? 'rgba(16,185,129,0.07)' : 'rgba(244,63,94,0.07)',
          borderWidth:2, pointRadius:0, fill:true, tension:0.35,
          spanGaps:true,
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            rtl:true, titleFont:{family:'Cairo',size:11},
            bodyFont:{family:'Cairo',size:11},
            mode:'index', intersect:false,
            callbacks:{ label: c => `${c.parsed.y?.toFixed(2)||'â€”'} Ø¬Ù†ÙŠÙ‡` }
          }
        },
        scales:{
          x:{
            grid:{color:'rgba(30,63,110,.35)',drawBorder:false},
            ticks:{font:{family:'Cairo',size:9}, color:'var(--fog)', maxTicksLimit:8}
          },
          y:{
            position:'right',
            grid:{color:'rgba(30,63,110,.35)',drawBorder:false},
            ticks:{font:{family:'Cairo',size:9}, color:'var(--fog)'}
          }
        }
      }
    });
    stat.textContent = tk + ' Â· Ø¢Ø®Ø± ' + previewDays + ' ÙŠÙˆÙ…';
  } catch(e) {
    stat.textContent = 'âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨ (CORS)';
    console.warn(e);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATE / FORMAT CONTROLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function qRange(years, el) {
  const now = new Date(), ago = new Date();
  ago.setFullYear(now.getFullYear() - years);
  document.getElementById('start-date').value = ago.toISOString().slice(0,10);
  document.getElementById('end-date').value   = now.toISOString().slice(0,10);
  document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
}

function setFmt(f, el) {
  fmt = f;
  document.querySelectorAll('.fmt-btn').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YAHOO FINANCE FETCH (via CORS proxy)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchTicker(ticker, startISO, endISO) {
  const p1  = Math.floor(new Date(startISO).getTime() / 1000);
  const p2  = Math.floor(new Date(endISO).getTime()   / 1000);
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&period1=${p1}&period2=${p2}&events=history`;

  try {
    const res  = await fetch(PROXY + encodeURIComponent(url), {signal: AbortSignal.timeout(15000)});
    const json = await res.json();
    const r    = json.chart?.result?.[0];
    if (!r) return null;

    const ts  = r.timestamps || r.timestamp || [];
    const q   = r.indicators.quote[0];
    const rows = [];

    ts.forEach((t, i) => {
      const close = q.close?.[i];
      if (close == null) return;
      const d    = new Date(t * 1000).toISOString().slice(0,10);
      const open = +(q.open?.[i]||0).toFixed(2);
      const high = +(q.high?.[i]||0).toFixed(2);
      const low  = +(q.low?.[i]||0).toFixed(2);
      const cl   = +close.toFixed(2);
      const vol  = q.volume?.[i] || 0;
      rows.push({
        "Ø§Ù„ØªØ§Ø±ÙŠØ®":            d,
        "Ø§Ù„Ø±Ù…Ø²":              ticker,
        "Ø§Ù„Ø´Ø±ÙƒØ©":             STOCKS[ticker]?.name || '',
        "Ø§Ù„Ù‚Ø·Ø§Ø¹":             STOCKS[ticker]?.sector || '',
        "Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØªØ§Ø­":      open,
        "Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±":          high,
        "Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø±":          low,
        "Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚":       cl,
        "Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„":       vol,
      });
    });

    // add daily change
    rows.forEach((r, i) => {
      const prev = i > 0 ? rows[i-1]["Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"] : r["Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"];
      r["Ø§Ù„ØªØºÙŠÙŠØ± (Ø¬Ù†ÙŠÙ‡)"] = +(r["Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"] - prev).toFixed(2);
      r["Ø§Ù„ØªØºÙŠÙŠØ± (%)"]    = prev ? +((r["Ø§Ù„ØªØºÙŠÙŠØ± (Ø¬Ù†ÙŠÙ‡)"] / prev)*100).toFixed(2) : 0;
    });

    return rows;
  } catch(e) {
    return null;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT EXCEL (SheetJS)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportXLSX(allData, startDate, endDate) {
  const wb = XLSX.utils.book_new();
  wb.Props = { Title:'EGX Historical Data', Author:'EGX Platform' };

  /* Sheet 1: Summary index */
  const idxRows = [["#","Ø§Ù„Ø±Ù…Ø²","Ø§Ù„Ø´Ø±ÙƒØ©","Ø§Ù„Ù‚Ø·Ø§Ø¹","Ø³Ø¬Ù„Ø§Øª","Ø£ÙˆÙ„ ØªØ§Ø±ÙŠØ®","Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ®"]];
  let i = 1;
  for (const [ticker, rows] of Object.entries(allData)) {
    if (!rows || rows.length === 0) continue;
    idxRows.push([i++, ticker, STOCKS[ticker]?.name||'', STOCKS[ticker]?.sector||'',
      rows.length, rows[0]["Ø§Ù„ØªØ§Ø±ÙŠØ®"], rows.at(-1)["Ø§Ù„ØªØ§Ø±ÙŠØ®"]]);
  }
  const wsIdx = XLSX.utils.aoa_to_sheet(idxRows);
  wsIdx['!cols'] = [{wch:4},{wch:14},{wch:28},{wch:16},{wch:10},{wch:14},{wch:14}];
  XLSX.utils.book_append_sheet(wb, wsIdx, 'Ø§Ù„ÙÙ‡Ø±Ø³');

  /* Sheet 2: All data combined */
  const allRows = [];
  for (const rows of Object.values(allData)) {
    if (rows) allRows.push(...rows);
  }
  if (allRows.length) {
    const wsAll = XLSX.utils.json_to_sheet(allRows);
    wsAll['!cols'] = Array(Object.keys(allRows[0]).length).fill({wch:16});
    XLSX.utils.book_append_sheet(wb, wsAll, 'ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  }

  /* Sheet per company */
  for (const [ticker, rows] of Object.entries(allData)) {
    if (!rows || rows.length === 0) continue;
    const ws   = XLSX.utils.json_to_sheet(rows);
    ws['!cols'] = Array(Object.keys(rows[0]).length).fill({wch:15});
    XLSX.utils.book_append_sheet(wb, ws, ticker.replace('.','_').slice(0,28));
  }

  /* Summary stats sheet */
  const statRows = [["Ø§Ù„Ø±Ù…Ø²","Ø§Ù„Ø´Ø±ÙƒØ©","Ø§Ù„Ù‚Ø·Ø§Ø¹","Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±","Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø±","Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±","Ø¢Ø®Ø± Ø¥ØºÙ„Ø§Ù‚","Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„"]];
  for (const [ticker, rows] of Object.entries(allData)) {
    if (!rows || rows.length === 0) continue;
    const closes = rows.map(r => r["Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚"]);
    statRows.push([
      ticker, STOCKS[ticker]?.name||'', STOCKS[ticker]?.sector||'',
      Math.max(...closes), Math.min(...closes),
      +(closes.reduce((a,b)=>a+b,0)/closes.length).toFixed(2),
      closes.at(-1), rows.length
    ]);
  }
  const wsStat = XLSX.utils.aoa_to_sheet(statRows);
  wsStat['!cols'] = [{wch:14},{wch:28},{wch:16},{wch:12},{wch:12},{wch:14},{wch:12},{wch:14}];
  XLSX.utils.book_append_sheet(wb, wsStat, 'Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠ');

  const fname = `EGX_Data_${startDate}_${endDate}.xlsx`;
  XLSX.writeFile(wb, fname);
}

function exportCSV(allData, startDate, endDate) {
  const allRows = [];
  for (const rows of Object.values(allData)) {
    if (rows) allRows.push(...rows);
  }
  if (!allRows.length) return;
  const headers = Object.keys(allRows[0]);
  const lines = [
    '\uFEFF' + headers.join(','),
    ...allRows.map(r => headers.map(h => {
      const v = r[h]; return typeof v === 'string' && v.includes(',') ? `"${v}"` : v;
    }).join(','))
  ];
  const blob = new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `EGX_Data_${startDate}_${endDate}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN DOWNLOAD FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startDownload() {
  const tickers = selected.size > 0 ? [...selected] : Object.keys(STOCKS);
  if (!tickers.length) { toast('âš ï¸ Ø§Ø®ØªØ± Ø´Ø±ÙƒØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','err'); return; }

  const startDate = document.getElementById('start-date').value;
  const endDate   = document.getElementById('end-date').value;
  if (!startDate || !endDate) { toast('âš ï¸ Ø­Ø¯Ø¯ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®','err'); return; }

  const cta  = document.getElementById('cta');
  const prog = document.getElementById('prog-wrap');
  const fill = document.getElementById('prog-fill');
  const lbl  = document.getElementById('prog-lbl');

  cta.disabled = true;
  cta.innerHTML = '<div class="spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>';
  prog.classList.add('show');

  const allData = {};
  let done = 0, failed = 0;

  // Batch fetch with concurrency limit
  const BATCH = 3;
  for (let i = 0; i < tickers.length; i += BATCH) {
    const batch = tickers.slice(i, i + BATCH);
    await Promise.all(batch.map(async tk => {
      const rows = await fetchTicker(tk, startDate, endDate);
      allData[tk] = rows;
      if (!rows || rows.length === 0) failed++;
      done++;
      const pct = Math.round((done / tickers.length) * 100);
      fill.style.width = pct + '%';
      lbl.textContent  = `ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${done} Ù…Ù† ${tickers.length} Ø´Ø±ÙƒØ© Â· ${pct}%` + (failed ? ` (${failed} Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª)` : '');
    }));
  }

  const successful = Object.values(allData).filter(r => r && r.length > 0).length;
  if (successful === 0) {
    toast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¬Ø±Ø¨ Ù†Ø·Ø§Ù‚Ø§Ù‹ Ø£Ø­Ø¯Ø«','err');
    cta.disabled = false;
    cta.innerHTML = '<span>â¬‡ï¸</span><span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>';
    prog.classList.remove('show');
    return;
  }

  // Export
  try {
    if (fmt === 'xlsx') exportXLSX(allData, startDate, endDate);
    else                exportCSV(allData, startDate, endDate);
    toast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª ${successful} Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!`,'ok');
  } catch(e) {
    toast('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù: ' + e.message,'err');
  }

  cta.disabled = false;
  cta.innerHTML = '<span>â¬‡ï¸</span><span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>';
  setTimeout(() => prog.classList.remove('show'), 3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast show ${type}`;
  setTimeout(() => el.classList.remove('show'), 5000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
init();
</script>
</body>
</html>
